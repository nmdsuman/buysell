<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>অ্যাডমিন প্যানেল</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Noto+Sans+Bengali:wght@400;700&display=swap');
        body {
            font-family: 'Noto Sans Bengali', 'Inter', sans-serif;
        }
        .animate-slide-in {
            animation: slideIn 0.5s forwards;
        }
        @keyframes slideIn {
            from {
                transform: translateX(100%);
            }
            to {
                transform: translateX(0);
            }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="root"></div>

    <!-- Lucide React icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, updateDoc, addDoc, deleteDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC50tfEA2h__peWlFCf4Dly5m_eEJ8br-s",
            authDomain: "bangla-story-9061a.firebaseapp.com",
            databaseURL: "https://bangla-story-9061a-default-rtdb.firebaseio.com",
            projectId: "bangla-story-9061a",
            storageBucket: "bangla-story-9061a.firebasestorage.app",
            messagingSenderId: "135733018669",
            appId: "1:135733018669:web:66e5c0903e612bf40538a4",
            measurementId: "G-X2W6RPC4PT"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const analytics = getAnalytics(app);

        // State management (replacing React's useState)
        let currentUser = null;
        let categories = [];
        let selectedCategory = null;
        let mainscreenimageUrl = '';
        let subcollectionData = [];
        let toastMessage = null;
        let activePanel = 'dataManagement';
        let showDeleteModal = false;
        let itemToDelete = null;
        let showCategoryDeleteModal = false;
        let editCategoryName = '';
        let editCategoryImageUrl = '';
        let newCategoryName = '';
        let newCategoryImageUrl = '';
        let newCategoryId = '';
        let editMode = null;
        let loginError = null;
        let contentError = null;
        let addError = null;
        let editError = null;
        let updateMainImageError = null;
        let isLoggingIn = false;

        // Render function (to re-render the UI when state changes)
        function render() {
            const root = document.getElementById('root');
            if (!root) return;
            root.innerHTML = ''; // Clear previous content

            // Check for user authentication state first
            if (currentUser) {
                renderApp();
            } else {
                renderLoginPage();
            }
            renderToast();
            
            // Re-render icons
            lucide.createIcons();
        }

        function renderToast() {
            let toastDiv = document.getElementById('toast-container');
            if (!toastDiv) {
                toastDiv = document.createElement('div');
                toastDiv.id = 'toast-container';
                document.body.appendChild(toastDiv);
            }
            toastDiv.innerHTML = '';
            if (toastMessage) {
                toastDiv.innerHTML = `
                    <div class="fixed bottom-5 right-5 z-50 p-4 bg-green-500 text-white rounded-lg shadow-xl flex items-center gap-2 animate-slide-in">
                        <i data-lucide="bell"></i>
                        <span>${toastMessage}</span>
                    </div>
                `;
                setTimeout(() => {
                    toastMessage = null;
                    renderToast();
                }, 3000);
            }
        }

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            render();
            // Fetch data after user logs in
            if (currentUser) {
                fetchCategories();
            }
        });

        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            loginError = null;
            isLoggingIn = true;
            renderLoginPage();

            signInWithEmailAndPassword(auth, email, password)
                .then(() => {
                    console.log("সফলভাবে লগইন করা হয়েছে।");
                })
                .catch((error) => {
                    console.error("লগইন ব্যর্থ হয়েছে:", error);
                    loginError = "লগইন ব্যর্থ হয়েছে। দয়া করে আপনার ইমেল এবং পাসওয়ার্ড চেক করুন।";
                    isLoggingIn = false;
                    renderLoginPage();
                });
        }

        function handleLogout() {
            signOut(auth)
                .then(() => {
                    console.log("সফলভাবে লগআউট করা হয়েছে।");
                    selectedCategory = null;
                    render();
                })
                .catch((error) => {
                    console.error("লগআউট ব্যর্থ হয়েছে:", error);
                });
        }
        
        function renderLoginPage() {
            const root = document.getElementById('root');
            root.innerHTML = `
                <div class="min-h-screen flex items-center justify-center bg-gray-100 font-sans p-4"
                     style="background-image: url('https://placehold.co/1920x1080/4F46E5/ffffff?text=Admin+Login'); background-size: cover; background-position: center;">
                    <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md backdrop-blur-sm bg-white/80 border border-gray-200">
                        <h2 class="text-3xl font-bold text-center text-gray-900 mb-6">অ্যাডমিন লগইন</h2>
                        ${loginError ? <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md mb-4"><p>${loginError}</p></div> : ''}
                        <form id="loginForm" class="space-y-6">
                            <div>
                                <label for="email" class="block text-gray-700 font-semibold mb-2">ইমেল</label>
                                <input type="email" id="email" class="w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring focus:ring-blue-200" placeholder="আপনার ইমেল লিখুন" required />
                            </div>
                            <div>
                                <label for="password" class="block text-gray-700 font-semibold mb-2">পাসওয়ার্ড</label>
                                <input type="password" id="password" class="w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring focus:ring-blue-200" placeholder="আপনার পাসওয়ার্ড লিখুন" required />
                            </div>
                            <button type="submit" class="w-full px-4 py-3 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 transition duration-200 flex items-center justify-center gap-2" ${isLoggingIn ? 'disabled' : ''}>
                                <i data-lucide="log-in" class="w-5 h-5"></i>
                                ${isLoggingIn ? 'লগইন হচ্ছে...' : 'লগইন'}
                            </button>
                        </form>
                    </div>
                </div>
            `;
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            lucide.createIcons();
        }

        // --- DATA FETCHING ---
        function fetchCategories() {
            const categoriesCollectionRef = collection(db, 'category');
            onSnapshot(categoriesCollectionRef, (snapshot) => {
                const categoryList = [];
                let mainScreenImg = '';
                snapshot.forEach(doc => {
                    if (doc.id === 'main_screen_background') {
                        mainScreenImg = doc.data()?.imageUrl || '';
                    } else {
                        categoryList.push({ id: doc.id, ...doc.data() });
                    }
                });
                categories = categoryList;
                mainscreenimageUrl = mainScreenImg;
                render();
                if (selectedCategory) {
                    // Re-fetch subcollection data if a category is already selected
                    fetchSubcollectionData();
                }
            }, (err) => {
                console.error("ক্যাটাগরি লোড করতে ব্যর্থ:", err);
            });
        }
        
        function fetchSubcollectionData() {
            if (!selectedCategory) {
                subcollectionData = [];
                return;
            }
            const subcollectionPath = /category/${selectedCategory.id}/all;
            const subcollectionRef = collection(db, subcollectionPath);

            onSnapshot(subcollectionRef, (snapshot) => {
                const dataList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                dataList.sort((a, b) => a.data.localeCompare(b.data));
                subcollectionData = dataList;
                render();
            }, (err) => {
                console.error("ডেটা লোড করতে ব্যর্থ:", err);
            });
        }

        // --- MAIN APP RENDER ---
        function renderApp() {
            const root = document.getElementById('root');
            root.innerHTML = `
                <div
                    class="min-h-screen font-sans text-gray-800 p-4 sm:p-6 lg:p-8 transition-all duration-500"
                    style="background-image: ${mainscreenimageUrl ? url('${mainscreenimageUrl}') : 'none'}; background-size: cover; background-position: center;"
                >
                    <div class="max-w-7xl mx-auto space-y-8 backdrop-blur-sm bg-white/70 p-6 rounded-2xl shadow-xl">
                        <div class="flex justify-between items-center pb-4 border-b border-gray-300">
                            <h1 class="text-3xl font-bold text-gray-900 drop-shadow-md">অ্যাডমিন প্যানেল</h1>
                            <div class="flex items-center space-x-4">
                                <span class="text-sm text-gray-700 hidden sm:block">হিসাবে লগইন করেছেন: <span class="font-semibold">${currentUser?.email}</span></span>
                                <button id="logoutBtn" class="px-4 py-2 bg-red-500 text-white font-bold rounded-lg shadow-md hover:bg-red-600 transition duration-200 flex items-center gap-2">
                                    <i data-lucide="log-out" class="w-5 h-5"></i> <span class="hidden sm:inline">লগআউট</span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="flex justify-center gap-4 mb-8">
                            <button id="dataManagementBtn" class="px-6 py-3 rounded-lg font-bold transition-colors duration-200 ${
                                activePanel === 'dataManagement' ? 'bg-blue-600 text-white shadow-lg' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                            }">
                                ডেটা ম্যানেজমেন্ট
                            </button>
                            <button id="categoryManagementBtn" class="px-6 py-3 rounded-lg font-bold transition-colors duration-200 ${
                                activePanel === 'categoryManagement' ? 'bg-blue-600 text-white shadow-lg' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                            }">
                                ক্যাটাগরি ম্যানেজমেন্ট
                            </button>
                        </div>

                        <div class="flex flex-col lg:flex-row gap-8">
                            ${activePanel === 'dataManagement' ? renderDataManagementPanel() : renderCategoryManagementPanel()}
                        </div>
                    </div>
                    ${showDeleteModal ? renderModal('ডেটা মুছে ফেলুন', আপনি কি নিশ্চিত যে আপনি এই ডেটাটি মুছে ফেলতে চান? "${itemToDelete?.data}"। এই অ্যাকশনটি ফিরিয়ে আনা যাবে না।, handleDeleteSubcollectionItem, () => { showDeleteModal = false; itemToDelete = null; render(); }) : ''}
                    ${showCategoryDeleteModal ? renderModal('ক্যাটাগরি মুছে ফেলুন', আপনি কি নিশ্চিত যে আপনি "${selectedCategory?.name}" ক্যাটাগরিটি মুছে ফেলতে চান? এই ক্যাটাগরির সমস্ত ডেটাও মুছে যাবে। এই অ্যাকশনটি ফিরিয়ে আনা যাবে না।, handleDeleteCategory, () => { showCategoryDeleteModal = false; render(); }) : ''}
                </div>
            `;

            // Attach event listeners after rendering
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.getElementById('dataManagementBtn').addEventListener('click', () => { activePanel = 'dataManagement'; render(); });
            document.getElementById('categoryManagementBtn').addEventListener('click', () => { activePanel = 'categoryManagement'; render(); });

            if (activePanel === 'dataManagement' && selectedCategory) {
                setupDataManagementEvents();
            } else if (activePanel === 'categoryManagement') {
                setupCategoryManagementEvents();
            }
        }
        
        // --- DATA MANAGEMENT PANEL ---
        function renderDataManagementPanel() {
            const categoryOptions = categories.map(cat => <option value="${cat.id}" ${selectedCategory?.id === cat.id ? 'selected' : ''}>${cat.name}</option>).join('');
            const subcollectionItems = subcollectionData.map(item => `
                <div class="p-3 rounded-lg shadow-sm border border-gray-200 transition-colors duration-200 ${item.status === 'completed' ? 'bg-green-100' : 'bg-gray-50'}">
                    ${editMode?.docId === item.id ? `
                        <div class="space-y-2">
                            <textarea id="edit-textarea-${item.id}" class="w-full rounded-md border-gray-300 shadow-sm p-2 min-h-[80px]">${editMode.data}</textarea>
                            <div class="flex gap-2">
                                <button data-docid="${item.id}" class="save-btn px-3 py-1 text-sm bg-green-500 text-white rounded-lg shadow-md hover:bg-green-600 transition duration-200">সংরক্ষণ করুন</button>
                                <button data-docid="${item.id}" class="cancel-edit-btn px-3 py-1 text-sm bg-gray-500 text-white rounded-lg shadow-md hover:bg-gray-600 transition duration-200">বাতিল</button>
                            </div>
                        </div>
                    ` : `
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2">
                            <div class="flex-grow flex items-center gap-3">
                                <button data-docid="${item.id}" data-status="${item.status}" class="toggle-status-btn text-sm rounded-full p-1 transition-all duration-200 ${item.status === 'completed' ? 'text-green-600 hover:text-green-700' : 'text-gray-400 hover:text-gray-600'}" title="${item.status === 'completed' ? 'সম্পূর্ণ' : 'অসম্পূর্ণ'}">
                                    <i data-lucide="${item.status === 'completed' ? 'check-circle' : 'circle'}" class="w-6 h-6"></i>
                                </button>
                                <p class="flex-grow whitespace-pre-wrap text-gray-700 ${item.status === 'completed' ? 'line-through text-gray-500' : ''}">${item.data}</p>
                            </div>
                            <div class="flex gap-2">
                                <button data-docid="${item.id}" class="edit-btn px-3 py-1 text-sm bg-yellow-500 text-white rounded-lg shadow-md hover:bg-yellow-600 transition duration-200 flex items-center">
                                    <i data-lucide="pencil" class="w-4 h-4"></i>
                                </button>
                                <button data-docid="${item.id}" class="delete-btn px-3 py-1 text-sm bg-red-500 text-white rounded-lg shadow-md hover:bg-red-600 transition duration-200 flex items-center">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    `}
                </div>
            `).join('');

            return `
                <div class="lg:w-1/2 p-6 bg-white rounded-xl shadow-lg border border-gray-200">
                    <h2 class="text-xl font-bold text-gray-900 mb-4">ডেটা ম্যানেজমেন্ট</h2>
                    <div class="mb-4">
                        <label class="block text-gray-700 font-semibold mb-1">ক্যাটাগরি নির্বাচন করুন</label>
                        <select id="categorySelect" class="w-full rounded-md border-gray-300 shadow-sm p-2">
                            <option value="">-- একটি ক্যাটাগরি নির্বাচন করুন --</option>
                            ${categoryOptions}
                        </select>
                    </div>
                    ${selectedCategory ? `
                        <>
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">"${selectedCategory.name}" এর ডেটা</h3>
                            ${contentError ? <div class="p-2 bg-red-100 text-red-700 rounded-md mb-4"><p>${contentError}</p></div> : ''}
                            <div class="mb-4 p-4 border border-dashed border-gray-300 rounded-lg">
                                <h4 class="font-semibold text-base mb-2">নতুন ডেটা যোগ করুন</h4>
                                <div class="flex flex-col sm:flex-row gap-2">
                                    <textarea id="newDataInput" class="flex-grow rounded-md border-gray-300 shadow-sm p-2 min-h-[50px]" placeholder="নতুন ডেটা লিখুন..."></textarea>
                                    <button id="addDataBtn" class="px-4 py-2 bg-blue-500 text-white font-bold rounded-lg shadow-md hover:bg-blue-600 transition duration-200 sm:w-auto w-full flex items-center justify-center gap-2">
                                        <i data-lucide="plus" class="w-4 h-4"></i> যোগ করুন
                                    </button>
                                </div>
                            </div>
                            <div class="space-y-3">
                                ${subcollectionItems}
                            </div>
                        </>
                    ` : ''}
                </div>
            `;
        }

        function setupDataManagementEvents() {
            document.getElementById('categorySelect').addEventListener('change', (e) => {
                const newCategoryId = e.target.value;
                selectedCategory = categories.find(cat => cat.id === newCategoryId);
                fetchSubcollectionData();
                render();
            });
            if (selectedCategory) {
                document.getElementById('addDataBtn').addEventListener('click', handleAddSubcollectionItem);
                document.getElementById('newDataInput').addEventListener('input', (e) => {
                    document.getElementById('addDataBtn').disabled = !e.target.value.trim();
                });
                document.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const docId = e.currentTarget.dataset.docid;
                        const item = subcollectionData.find(i => i.id === docId);
                        editMode = { docId: item.id, data: item.data };
                        render();
                    });
                });
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const docId = e.currentTarget.dataset.docid;
                        itemToDelete = subcollectionData.find(i => i.id === docId);
                        showDeleteModal = true;
                        render();
                    });
                });
                document.querySelectorAll('.toggle-status-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const docId = e.currentTarget.dataset.docid;
                        const status = e.currentTarget.dataset.status;
                        handleToggleStatus(docId, status);
                    });
                });
                if (editMode) {
                    document.querySelector('.save-btn').addEventListener('click', (e) => {
                        const docId = e.currentTarget.dataset.docid;
                        const newData = document.getElementById(edit-textarea-${docId}).value;
                        handleUpdateSubcollectionItem(docId, newData);
                    });
                    document.querySelector('.cancel-edit-btn').addEventListener('click', () => {
                        editMode = null;
                        render();
                    });
                }
            }
        }
        
        function handleAddSubcollectionItem() {
            if (!selectedCategory) return;
            const newDataInput = document.getElementById('newDataInput');
            const data = newDataInput.value.trim();
            if (!data) {
                contentError = "নতুন ডেটা এবং একটি ক্যাটাগরি নির্বাচন করা আবশ্যক।";
                render();
                return;
            }
            addDoc(collection(db, category/${selectedCategory.id}/all), { data: data, status: 'incomplete' })
                .then(() => {
                    newDataInput.value = '';
                    toastMessage = 'নতুন ডেটা সফলভাবে যোগ করা হয়েছে!';
                    render();
                })
                .catch((e) => {
                    contentError = "নতুন আইটেম যোগ করতে ব্যর্থ: " + e.message;
                    render();
                });
        }
        
        function handleUpdateSubcollectionItem(docId, newData) {
            if (!selectedCategory) return;
            if (!newData.trim()) {
                contentError = "ডেটা খালি রাখা যাবে না।";
                render();
                return;
            }
            updateDoc(doc(db, category/${selectedCategory.id}/all, docId), { data: newData })
                .then(() => {
                    editMode = null;
                    toastMessage = 'ডেটা সফলভাবে আপডেট করা হয়েছে!';
                    render();
                })
                .catch((e) => {
                    contentError = "আইটেম আপডেট করতে ব্যর্থ: " + e.message;
                    render();
                });
        }
        
        function handleDeleteSubcollectionItem() {
            if (!selectedCategory || !itemToDelete) return;
            deleteDoc(doc(db, category/${selectedCategory.id}/all, itemToDelete.id))
                .then(() => {
                    toastMessage = 'ডেটা সফলভাবে মুছে ফেলা হয়েছে!';
                    showDeleteModal = false;
                    itemToDelete = null;
                    render();
                })
                .catch((e) => {
                    contentError = "আইটেম মুছে ফেলতে ব্যর্থ: " + e.message;
                    render();
                });
        }

        function handleToggleStatus(docId, currentStatus) {
            if (!selectedCategory) return;
            const newStatus = currentStatus === 'completed' ? 'incomplete' : 'completed';
            updateDoc(doc(db, category/${selectedCategory.id}/all, docId), { status: newStatus })
                .then(() => {
                    toastMessage = 'অবস্থা সফলভাবে আপডেট করা হয়েছে!';
                    render();
                })
                .catch((e) => {
                    contentError = "অবস্থা আপডেট করতে ব্যর্থ: " + e.message;
                    render();
                });
        }

        // --- CATEGORY MANAGEMENT PANEL ---
        function renderCategoryManagementPanel() {
            const categoryOptions = categories.map(cat => <option value="${cat.id}" ${selectedCategory?.id === cat.id ? 'selected' : ''}>${cat.name}</option>).join('');
            
            return `
                <div class="lg:w-1/2 space-y-8">
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                        <h3 class="text-xl font-bold text-gray-900 mb-4">নতুন ক্যাটাগরি যোগ করুন</h3>
                        ${addError ? <div class="p-2 bg-red-100 text-red-700 rounded-md mb-4"><p>${addError}</p></div> : ''}
                        <div class="space-y-2">
                            <input type="text" id="newCategoryIdInput" value="${newCategoryId}" placeholder="ক্যাটাগরি আইডি (ঐচ্ছিক)" class="w-full rounded-md border-gray-300 shadow-sm p-2" />
                            <input type="text" id="newCategoryNameInput" value="${newCategoryName}" placeholder="ক্যাটাগরির নাম" class="w-full rounded-md border-gray-300 shadow-sm p-2" />
                            <input type="text" id="newCategoryImageUrlInput" value="${newCategoryImageUrl}" placeholder="ব্যাকগ্রাউন্ড ইমেজ URL" class="w-full rounded-md border-gray-300 shadow-sm p-2" />
                            <button id="addCategoryBtn" class="w-full px-4 py-2 bg-purple-500 text-white font-bold rounded-lg shadow-md hover:bg-purple-600 transition duration-200 flex items-center justify-center gap-2">
                                <i data-lucide="plus" class="w-5 h-5 mr-2"></i> যোগ করুন
                            </button>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                        <h3 class="text-xl font-bold text-gray-900 mb-4">ক্যাটাগরি সম্পাদনা ও মুছুন</h3>
                        <div class="mb-4">
                            <label class="block text-gray-700 font-semibold mb-1">ক্যাটাগরি নির্বাচন করুন</label>
                            <select id="editCategorySelect" class="w-full rounded-md border-gray-300 shadow-sm p-2">
                                <option value="">-- একটি ক্যাটাগরি নির্বাচন করুন --</option>
                                ${categoryOptions}
                            </select>
                        </div>
                        ${editError ? <div class="p-2 bg-red-100 text-red-700 rounded-md mb-4"><p>${editError}</p></div> : ''}
                        ${selectedCategory ? `
                            <div class="space-y-4">
                                <label class="block">
                                    <span class="text-gray-700">নাম:</span>
                                    <input type="text" id="editCategoryNameInput" value="${editCategoryName}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" />
                                </label>
                                <label class="block">
                                    <span class="text-gray-700">ব্যাকগ্রাউন্ড ইমেজ URL:</span>
                                    <input type="text" id="editCategoryImageUrlInput" value="${editCategoryImageUrl}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" />
                                </label>
                                <div class="flex gap-2">
                                    <button id="updateCategoryBtn" class="w-full px-4 py-2 bg-green-500 text-white font-bold rounded-lg shadow-md hover:bg-green-600 transition duration-200 flex items-center justify-center gap-2">
                                        <i data-lucide="pencil" class="w-4 h-4"></i> আপডেট করুন
                                    </button>
                                    <button id="deleteCategoryBtn" class="w-full px-4 py-2 bg-red-500 text-white font-bold rounded-lg shadow-md hover:bg-red-600 transition duration-200 flex items-center justify-center gap-2">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i> মুছে ফেলুন
                                    </button>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                        <h2 class="text-xl font-bold text-gray-900 mb-4">মেইন স্ক্রিন ইমেজ আপডেট</h2>
                        ${updateMainImageError ? <div class="p-2 bg-red-100 text-red-700 rounded-md mb-4"><p>${updateMainImageError}</p></div> : ''}
                        <div class="flex flex-col sm:flex-row gap-4">
                            <input type="text" id="mainImageInput" value="${mainscreenimageUrl}" placeholder="ইমেজ URL" class="flex-grow rounded-md border-gray-300 shadow-sm p-2" />
                            <button id="updateMainImageBtn" class="px-4 py-2 bg-green-500 text-white font-bold rounded-lg shadow-md hover:bg-green-600 transition duration-200">
                                আপডেট করুন
                            </button>
                        </div>
                        ${mainscreenimageUrl ? `
                            <div class="mt-4">
                                <p class="font-semibold mb-2">বর্তমান ইমেজ:</p>
                                <img src="${mainscreenimageUrl}" alt="Main screen" class="w-full h-48 object-cover rounded-lg" onerror="this.src='https://placehold.co/600x400/CCCCCC/333333?text=Image+Not+Found';" />
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function setupCategoryManagementEvents() {
            document.getElementById('editCategorySelect').addEventListener('change', (e) => {
                const newCategoryId = e.target.value;
                selectedCategory = categories.find(cat => cat.id === newCategoryId);
                if (selectedCategory) {
                    editCategoryName = selectedCategory.name;
                    editCategoryImageUrl = selectedCategory.backgroundImageUrl;
                } else {
                    editCategoryName = '';
                    editCategoryImageUrl = '';
                }
                render();
            });

            document.getElementById('newCategoryIdInput').addEventListener('input', (e) => newCategoryId = e.target.value);
            document.getElementById('newCategoryNameInput').addEventListener('input', (e) => newCategoryName = e.target.value);
            document.getElementById('newCategoryImageUrlInput').addEventListener('input', (e) => newCategoryImageUrl = e.target.value);
            document.getElementById('addCategoryBtn').addEventListener('click', handleAddCategory);
            
            if (selectedCategory) {
                document.getElementById('editCategoryNameInput').addEventListener('input', (e) => { editCategoryName = e.target.value; });
                document.getElementById('editCategoryImageUrlInput').addEventListener('input', (e) => { editCategoryImageUrl = e.target.value; });
                document.getElementById('updateCategoryBtn').addEventListener('click', handleUpdateCategory);
                document.getElementById('deleteCategoryBtn').addEventListener('click', () => { showCategoryDeleteModal = true; render(); });
            }

            document.getElementById('mainImageInput').addEventListener('input', (e) => { mainscreenimageUrl = e.target.value; });
            document.getElementById('updateMainImageBtn').addEventListener('click', updateMainscreenImage);
        }

        function handleAddCategory() {
            if (!newCategoryName.trim()) {
                addError = "ক্যাটাগরির নাম খালি রাখা যাবে না।";
                render();
                return;
            }
            const collectionRef = collection(db, category);
            const promise = newCategoryId.trim()
                ? setDoc(doc(collectionRef, newCategoryId), { name: newCategoryName, backgroundImageUrl: newCategoryImageUrl })
                : addDoc(collectionRef, { name: newCategoryName, backgroundImageUrl: newCategoryImageUrl });
            
            promise.then(() => {
                toastMessage = 'নতুন ক্যাটাগরি সফলভাবে যোগ করা হয়েছে!';
                newCategoryName = '';
                newCategoryImageUrl = '';
                newCategoryId = '';
                render();
            }).catch(e => {
                addError = "নতুন ক্যাটাগরি যোগ করতে ব্যর্থ: " + e.message;
                render();
            });
        }
        
        function handleUpdateCategory() {
            if (!selectedCategory) {
                editError = "একটি ক্যাটাগরি নির্বাচন করা আবশ্যক।";
                render();
                return;
            }
            if (!editCategoryName.trim()) {
                editError = "ক্যাটাগরির নাম খালি রাখা যাবে না।";
                render();
                return;
            }
            updateDoc(doc(db, category, selectedCategory.id), {
                name: editCategoryName,
                backgroundImageUrl: editCategoryImageUrl
            }).then(() => {
                toastMessage = 'ক্যাটাগরি সফলভাবে আপডেট করা হয়েছে!';
                render();
            }).catch(e => {
                editError = "ক্যাটাগরি আপডেট করতে ব্যর্থ: " + e.message;
                render();
            });
        }

        function handleDeleteCategory() {
            if (!selectedCategory) return;
            deleteDoc(doc(db, category, selectedCategory.id))
                .then(() => {
                    toastMessage = 'ক্যাটাগরি সফলভাবে মুছে ফেলা হয়েছে!';
                    selectedCategory = null;
                    showCategoryDeleteModal = false;
                    render();
                })
                .catch((e) => {
                    editError = "ক্যাটাগরি মুছে ফেলতে ব্যর্থ: " + e.message;
                    showCategoryDeleteModal = false;
                    render();
                });
        }
        
        function updateMainscreenImage() {
            setDoc(doc(db, category, 'main_screen_background'), { imageUrl: mainscreenimageUrl })
                .then(() => {
                    toastMessage = 'মেইন স্ক্রিন ব্যাকগ্রাউন্ড সফলভাবে আপডেট করা হয়েছে!';
                    render();
                })
                .catch((e) => {
                    updateMainImageError = "মেইন স্ক্রিন ইমেজ আপডেট করতে ব্যর্থ: " + e.message;
                    render();
                });
        }
        
        // --- MODAL COMPONENT (Vanilla JS) ---
        function renderModal(title, message, onConfirm, onCancel) {
            const modalHtml = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full space-y-4">
                        <div class="flex items-center gap-2 text-red-500">
                            <i data-lucide="alert-circle" class="w-6 h-6"></i>
                            <h3 class="text-xl font-bold text-gray-900">${title}</h3>
                        </div>
                        <p class="text-gray-700">${message}</p>
                        <div class="flex justify-end gap-3">
                            <button id="modalCancelBtn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg font-semibold hover:bg-gray-400 transition duration-200">বাতিল</button>
                            <button id="modalConfirmBtn" class="px-4 py-2 bg-red-500 text-white rounded-lg font-semibold hover:bg-red-600 transition duration-200">মুছে ফেলুন</button>
                        </div>
                    </div>
                </div>
            `;
            // This is a simple modal implementation. In a real-world app, you might create and append a DOM element.
            // For this single-file HTML, we'll return the HTML string and let the main render function handle it.
            // Events will be attached after rendering
            setTimeout(() => {
                document.getElementById('modalConfirmBtn')?.addEventListener('click', onConfirm);
                document.getElementById('modalCancelBtn')?.addEventListener('click', onCancel);
            }, 0);
            return modalHtml;
        }
    </script>
</body>
</html>
